<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>TValue Widget</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu,
          Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
        background-color: #f5f5f7;
        margin: 0;
        padding: 3rem;
      }
      .container {
        max-width: 1320px;
        margin: auto;
        background: white;
        border-radius: 16px;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        padding: 2.75rem;
      }
      .form-group {
        margin-bottom: 1rem;
      }
      label {
        font-weight: 500;
        display: block;
        margin-bottom: 0.5rem;
      }
      input {
        width: 100%;
        padding: 0.5rem;
        border: 1px solid #ccc;
        border-radius: 8px;
        font-size: 1rem;
      }
      button {
        background-color: #007aff;
        color: white;
        border: none;
        padding: 0.75rem 1.5rem;
        border-radius: 8px;
        font-size: 1rem;
        cursor: pointer;
        margin-top: 1rem;
      }
      h2 {
        font-size: 1.4rem;
        margin-bottom: 1rem;
      }
      .result-box {
        margin-top: 2rem;
        padding: 1.5rem;
        background: #fff;
        border-radius: 16px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
      }
      .result-box h3 {
        margin-top: 0;
      }
      .card {
        background: #f1f1f3;
        padding: 1rem;
        border-radius: 12px;
        margin-top: 0.5rem;
      }
      .am-schedule-grid {
        display: grid;
        gap: 1rem;
        grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      }
      .am-schedule-column {
        display: flex;
        flex-direction: column;
        min-width: 380px;
      }
      .am-schedule-table {
        width: 100%;
        border-collapse: collapse;
        background: #f1f1f3;
        border-radius: 12px;
        overflow: hidden;
        margin-top: 0.5rem;
      }
      .am-schedule-table th,
      .am-schedule-table td {
        padding: 0.5rem 0.75rem;
        text-align: left;
        font-size: 0.9rem;
        white-space: nowrap;
      }
      .am-schedule-table th:nth-child(1),
      .am-schedule-table td:nth-child(1) {
        min-width: 36px;
      }
      .am-schedule-table th:nth-child(2),
      .am-schedule-table td:nth-child(2) {
        min-width: 72px;
      }
      .am-schedule-table th:nth-child(3),
      .am-schedule-table td:nth-child(3),
      .am-schedule-table th:nth-child(5),
      .am-schedule-table td:nth-child(5) {
        min-width: 84px;
      }
      .am-schedule-table th:nth-child(4),
      .am-schedule-table td:nth-child(4) {
        min-width: 116px;
      }
      .am-schedule-table thead {
        background: #e7e7ea;
      }
      .am-schedule-table tbody tr + tr {
        border-top: 1px solid rgba(0, 0, 0, 0.06);
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h2>TValue Widget</h2>
      <div class="form-group">
        <label>Funding Amount Gross</label>
        <input id="funding" type="number" />
      </div>
      <div class="form-group">
        <label>Customer Payment Gross</label>
        <input id="payment" type="number" />
      </div>
      <div class="form-group">
        <label>Term</label>
        <input id="term" type="number" value="36" />
      </div>
      <div class="form-group">
        <label>Submitted for Payout</label>
        <input id="startDate" type="date" />
      </div>
      <div class="form-group">
        <label>Rate</label>
        <input id="rate" type="number" step="0.0001" value="9.25" />
      </div>
      <button onclick="calculateTValue()">Calculate</button>
      <button onclick="exportPDF()">Export PDF</button>

      <div class="result-box" id="parsed" style="display:none">
        <h3>ðŸ“Š TValue Results</h3>
        <h4>ðŸ“‹ Cash Flow Schedule</h4>
        <div id="vCashflow"></div>
        <h4>ðŸ§¾ Am Schedule</h4>
        <div id="vAmSchedule" class="am-schedule-grid"></div>
      </div>
    </div>

    <script>
      document.addEventListener('DOMContentLoaded', () => {
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('startDate').value = today;
      });

      async function calculateTValue() {
        const lease = parseFloat(document.getElementById('funding').value);
        const payment = parseFloat(document.getElementById('payment').value);
        const term = parseInt(document.getElementById('term').value);
        const startDate = document.getElementById('startDate').value;
        const rate = parseFloat(document.getElementById('rate').value) / 100;

        const leaseCents = Math.round(lease * 100);
        const paymentCents = Math.round(payment * 100);

        const cfm = [
          { Amount: leaseCents, Event: "Loan", Number: 1, StartDate: startDate },
          { Amount: "Unknown", Event: "Loan", Number: 1, StartDate: startDate },
          { Amount: paymentCents, Event: "Payment", Number: term - 1, Period: "Monthly", StartDate: startDate },
          { Amount: paymentCents, Event: "Payment", Number: 1, StartDate: new Date(new Date(startDate).setMonth(new Date(startDate).getMonth() + term - 1)).toISOString().split('T')[0] }
        ];

        const payload = {
          CustomerId: "6774400739051474671",
          CreateAmSchedule: true,
          CreateAMSchedule: true,
          RoundingType: "SpecificLine",
          SpecificLine: 3,
          LineAdjustment: "LastAmount",
          Document: {
            CFM: cfm,
            Label: "Zoho TValue Commission Only",
            Period: "Monthly",
            Rate: rate,
            Schema: 6,
            YearLength: 365
          }
        };

        const res = await fetch("https://tvaluerestws.com/WebApi/calculate/", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        const json = await res.json();
        const commission = (json?.CFM?.Unknowns?.Value / 100).toFixed(2);

        let cards = "";
        json.CFM.CFM.forEach((item, i) => {
          let text = "";
          if (i === 0) text = `#1 â†’ Funding Amount Gross: $${(item.Amount / 100).toFixed(2)} on ${item.StartDate}`;
          else if (i === 1) text = `#2 â†’ Commission: $${(item.Amount / 100).toFixed(2)} on ${item.StartDate}`;
          else if (i === 2) text = `#3 â†’ Payment: $${(item.Amount / 100).toFixed(2)} on ${item.StartDate} (Monthly)`;
          else if (i === 3) text = `#4 â†’ Last Payment on: ${item.StartDate}`;
          if (text) {
            cards += `<div class='card'>${text}</div>`;
          }
        });
        cards += `<div class='card'>#5 â†’ Rate: ${(json.CFM.Rate * 100).toFixed(2)}%</div>`;

        document.getElementById('vCashflow').innerHTML = cards.trim();
        const amScheduleSource = [
          json?.AmortizationTable,
          json?.AmSchedule,
          json?.AMSchedule,
          json?.AmortizationSchedule,
          json?.Amortization?.AmortizationTable,
          json?.CFM?.AmortizationTable,
          json?.CFM?.AmSchedule,
          json?.CFM?.AMSchedule,
          json?.CFM?.AmortizationSchedule,
          json?.CFM?.Amortization?.AmortizationTable
        ].find(Boolean);
        const amScheduleEntries = Array.isArray(amScheduleSource)
          ? amScheduleSource
          : amScheduleSource?.Schedule ||
            amScheduleSource?.CFM ||
            amScheduleSource?.Items ||
            amScheduleSource?.Lines ||
            amScheduleSource?.AmortizationTable ||
            [];
        const excludedLineTypes = new Set([
          "Loan",
          "Month Totals",
          "Quarter Totals",
          "Annual Totals",
          "Grand Totals",
          "Rounding"
        ]);
        const filteredAmEntries = Array.isArray(amScheduleEntries)
          ? amScheduleEntries.filter((item) => !excludedLineTypes.has(item?.AmortizationLineType))
          : [];
        const paymentEntries = filteredAmEntries.filter(
          (item) => item?.AmortizationLineType === "Payment"
        );
        if (!paymentEntries.length) {
          document.getElementById('vAmSchedule').innerHTML = "<div class='card'>No Am Schedule data available.</div>";
          document.getElementById('parsed').style.display = 'block';
          return;
        }
        const columnCount = Math.max(1, Math.ceil(term / 12));
        const amColumns = Array.from({ length: columnCount }, () => []);
        const itemsPerColumn = Math.max(1, Math.ceil(term / columnCount));
        paymentEntries.forEach((item, index) => {
          const columnIndex = Math.min(Math.floor(index / itemsPerColumn), columnCount - 1);
          const dataAmount = item?.Data?.PaymentAmount != null && item.Data.PaymentAmount !== 0
            ? item.Data.PaymentAmount
            : item?.Data?.LoanAmount != null && item.Data.LoanAmount !== 0
              ? item.Data.LoanAmount
              : item?.Data?.PrincipalPaid != null && item.Data.PrincipalPaid !== 0
                ? item.Data.PrincipalPaid
                : null;
          const amount = item?.Amount != null
            ? `$${(item.Amount / 100).toFixed(2)}`
            : dataAmount != null
              ? `$${(dataAmount / 100).toFixed(2)}`
              : "N/A";
          const date = item?.Date || item?.StartDate || "N/A";
          const label = item?.Label || item?.Event || item?.AmortizationLineType || "Am Schedule Item";
          const balance = item?.Data?.Balance != null
            ? `$${(item.Data.Balance / 100).toFixed(2)}`
            : "";
          const row = `<tr><td>#${index + 1}</td><td>${label}</td><td>${amount}</td><td>${date}</td><td>${balance || "-"}</td></tr>`;
          amColumns[columnIndex].push(row);
        });
        const amTables = amColumns.map((rows) => {
          const body = rows.length ? rows.join("") : "<tr><td colspan='5'>No data</td></tr>";
          return `
            <div class='am-schedule-column'>
              <table class='am-schedule-table'>
                <thead>
                  <tr>
                    <th>#</th>
                    <th>Type</th>
                    <th>Amount</th>
                    <th>Date</th>
                    <th>Balance</th>
                  </tr>
                </thead>
                <tbody>
                  ${body}
                </tbody>
              </table>
            </div>
          `;
        }).join("");
        const amScheduleElement = document.getElementById('vAmSchedule');
        amScheduleElement.style.gridTemplateColumns = `repeat(${columnCount}, minmax(380px, 1fr))`;
        amScheduleElement.innerHTML = amTables;
        document.getElementById('parsed').style.display = 'block';
      }

      function exportPDF() {
        import('https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js').then(() => {
          const parsedEl = document.querySelector('#parsed');
          if (!parsedEl || parsedEl.style.display === 'none') {
            alert('Run Calculate before exporting to PDF.');
            return;
          }

          const captureWidth = Math.ceil(parsedEl.scrollWidth);
          const captureHeight = Math.ceil(parsedEl.scrollHeight);

          html2canvas(parsedEl, {
            scale: 2,
            useCORS: true,
            backgroundColor: '#ffffff',
            width: captureWidth,
            height: captureHeight,
            windowWidth: captureWidth,
            windowHeight: captureHeight,
            scrollX: 0,
            scrollY: 0
          }).then(canvas => {
            const imgData = canvas.toDataURL('image/png');
            const pdf = new jspdf.jsPDF('p', 'mm', 'a4');
            const pdfWidth = pdf.internal.pageSize.getWidth();
            const pdfHeight = pdf.internal.pageSize.getHeight();

            const margin = 6;
            const usableWidth = pdfWidth - margin * 2;
            const usableHeight = pdfHeight - margin * 2;

            const imgWidth = usableWidth;
            const imgHeight = (canvas.height * imgWidth) / canvas.width;
            let currentY = 0;

            pdf.addImage(imgData, 'PNG', margin, margin, imgWidth, imgHeight);
            currentY += usableHeight;

            while (currentY < imgHeight) {
              pdf.addPage();
              pdf.addImage(imgData, 'PNG', margin, margin - currentY, imgWidth, imgHeight);
              currentY += usableHeight;
            }

            pdf.save('tvalue_result.pdf');
          });
        });
      }
    </script>
  </body>
</html>
